<!DOCTYPE html>
<html lang="rw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ikizamini cyo Kwiga Amategeko y’Umuhanda</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f9f9f9;
    }
    header {
      text-align: center;
      margin-bottom: 1rem;
    }
    #timer {
      font-weight: bold;
      font-size: 1.3rem;
      color: #d33;
    }
    #question-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 8px #ccc;
      margin-bottom: 1rem;
    }
    #question-text {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    #question-image {
      max-width: 100%;
      max-height: 200px;
      margin-bottom: 1rem;
      display: none;
    }
    .choice {
      background: #eee;
      padding: 0.7rem 1rem;
      margin-bottom: 0.6rem;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }
    .choice:hover {
      background: #ddd;
    }
    .choice.selected {
      background: #0b79d0;
      color: white;
      font-weight: bold;
    }
    #nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }
    button {
      background: #0b79d0;
      border: none;
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #095a9d;
    }
  </style>
</head>
<body>

<header>
  <h1>Ikizamini cyo Kwiga Amategeko y’Umuhanda</h1>
  <div id="timer">Igihe gisigaye: 20:00</div>
</header>

<div id="question-container">
  <h2 id="question-text"></h2>
  <img id="question-image" alt="Question Image" />
  <div id="choices"></div>
</div>

<div id="nav-buttons">
  <button id="prev-btn" disabled>Inyuma</button>
  <button id="next-btn" disabled>Gukomeza</button>
  <button id="submit-btn" disabled>Ohereza Ikizamini</button>
</div>

<!-- JS Ibibazo - ugomba kugira questions.js -->
<script src="js/questions.js"></script>

<script>
  const TOTAL_QUESTIONS_TO_ASK = 20;
  const STORAGE_KEY = 'examState';

  // Ibintu by'ingenzi bizakurikiranwa
  let questionSet = [];
  let currentQuestionIndex = 0;
  let selectedAnswers = {};
  let timerSecondsLeft = 20 * 60;

  // Ibice bya DOM
  const timerDisplay = document.getElementById('timer');
  const questionText = document.getElementById('question-text');
  const questionImage = document.getElementById('question-image');
  const choicesContainer = document.getElementById('choices');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const submitBtn = document.getElementById('submit-btn');

  // Fungura state niba ihari
  const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if (savedState
      && savedState.questionSet 
      && savedState.questionSet.length === TOTAL_QUESTIONS_TO_ASK
      && savedState.selectedAnswers
      && typeof savedState.currentQuestionIndex === 'number'
      && typeof savedState.timerSecondsLeft === 'number') {
    questionSet = savedState.questionSet;
    selectedAnswers = savedState.selectedAnswers;
    currentQuestionIndex = savedState.currentQuestionIndex;
    timerSecondsLeft = savedState.timerSecondsLeft;
  } else {
    if (!window.questions || !Array.isArray(window.questions)) {
      alert('Ibibazo ntibibashije kwinjizwa.');
    }
    questionSet = [...window.questions]
      .sort(() => Math.random() - 0.5)
      .slice(0, TOTAL_QUESTIONS_TO_ASK)
      // Fata id kuri buri kibazo niba itaraboneka
      .map((q,i) => ({ id: q.id || i+1, ...q }));
    selectedAnswers = {};
    currentQuestionIndex = 0;
    timerSecondsLeft = 20 * 60;
    saveState();
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      questionSet,
      selectedAnswers,
      currentQuestionIndex,
      timerSecondsLeft
    }));
  }

  // Render question muri DOM
  function renderQuestion(index) {
    const q = questionSet[index];
    questionText.textContent = `${index + 1}. ${q.question}`;
    if (q.image) {
      questionImage.src = `images/${q.image}`;
      questionImage.style.display = 'block';
    } else {
      questionImage.style.display = 'none';
      questionImage.src = '';
    }

    choicesContainer.innerHTML = '';
    ['a','b','c','d'].forEach(letter => {
      if (!q[letter]) return;
      const div = document.createElement('div');
      div.className = 'choice';
      div.textContent = `${letter.toUpperCase()}. ${q[letter]}`;
      div.dataset.letter = letter;
      if (selectedAnswers[q.id] === letter) div.classList.add('selected');

      div.addEventListener('click', () => {
        document.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        selectedAnswers[q.id] = letter;
        updateSubmitButton();
        saveState();
      });

      choicesContainer.appendChild(div);
    });

    updateButtons();
  }

  function updateButtons() {
    prevBtn.disabled = currentQuestionIndex === 0;
    nextBtn.disabled = currentQuestionIndex === questionSet.length - 1;
  }

  function updateSubmitButton() {
    const allAnswered = questionSet.every(q => selectedAnswers[q.id]);
    submitBtn.disabled = !allAnswered;
  }

  prevBtn.addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderQuestion(currentQuestionIndex);
      saveState();
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentQuestionIndex < questionSet.length - 1) {
      currentQuestionIndex++;
      renderQuestion(currentQuestionIndex);
      saveState();
    }
  });

  submitBtn.addEventListener('click', () => {
    let score = 0;
    questionSet.forEach(q => {
      if (selectedAnswers[q.id] === q.answer) score++;
    });
    localStorage.setItem('score', score);
    localStorage.setItem('total', questionSet.length);
    localStorage.setItem('answers', JSON.stringify(selectedAnswers));
    localStorage.setItem('questions', JSON.stringify(questionSet));

    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem('remainingTime');

    window.location.href = 'results.html';
  });

  // Timer
  function startTimer() {
    const interval = setInterval(() => {
      if (timerSecondsLeft <= 0) {
        clearInterval(interval);
        alert('Igihe cyawe kirarangiye! Ikizamini kiroherezwa.');
        submitBtn.click();
        return;
      }
      timerSecondsLeft--;
      const min = Math.floor(timerSecondsLeft / 60);
      const sec = timerSecondsLeft % 60;
      timerDisplay.textContent = `Igihe gisigaye: ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      saveState();
    }, 1000);
  }

  // Initialize
  renderQuestion(currentQuestionIndex);
  updateSubmitButton();
  startTimer();

</script>

</body>
</html>
